# é•¿æ–‡æ·±åº¦è§£æï¼šå¤§æ¨¡å‹çš„"ä¸Šä¸‹æ–‡é™·é˜±"ä¸6å¤§ä¿®å¤æŠ€å·§

## å¼•è¨€

éšç€ GPT-4.5ã€Claude 4.5ã€Gemini 2.5 ç­‰å¤§æ¨¡å‹ç›¸ç»§æ¨å‡ºç™¾ä¸‡çº§ä¸Šä¸‹æ–‡çª—å£ï¼Œæ•´ä¸ªAIåœˆéƒ½æ²¸è…¾äº†ã€‚å¾ˆå¤šäººè®¤ä¸ºï¼šåªè¦ä¸Šä¸‹æ–‡çª—å£å¤Ÿå¤§ï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰å·¥å…·ã€æ–‡æ¡£ã€å†å²è®°å½•ç»Ÿç»Ÿå¡è¿›å»ï¼Œè®©æ¨¡å‹è‡ªå·±å¤„ç†â€”â€”è¿™ä¸å°±æ˜¯æˆ‘ä»¬æ¢¦å¯ä»¥æ±‚çš„è¶…çº§æ™ºèƒ½åŠ©æ‰‹å—ï¼Ÿ

ä½†ç°å®è¿œæ¯”æƒ³è±¡æ®‹é…·ã€‚

**æ›´é•¿çš„ä¸Šä¸‹æ–‡ä¸ç­‰äºæ›´å¥½çš„å“åº”ã€‚** äº‹å®ä¸Šï¼Œå½“ä¸Šä¸‹æ–‡è¿‡è½½æ—¶ï¼Œä½ çš„AIåº”ç”¨å¯èƒ½ä¼šä»¥å„ç§æ„æƒ³ä¸åˆ°çš„æ–¹å¼å´©æºƒï¼šäº§ç”Ÿå¹»è§‰ã€é‡å¤è¿‡å»çš„é”™è¯¯ã€è°ƒç”¨æ— å…³çš„å·¥å…·ï¼Œç”šè‡³è‡ªç›¸çŸ›ç›¾ã€‚

æœ€è¿‘ï¼ŒLangChain å›¢é˜ŸåŸºäº Drew Breunig çš„æ·±åº¦åˆ†ææ–‡ç« ã€ŠHow to Fix Your Contextã€‹ï¼Œå¼€æºäº†ä¸€å¥—å®Œæ•´çš„ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼ˆContext Engineeringï¼‰å®è·µæ–¹æ¡ˆã€‚ä½œä¸ºå¤§æ¨¡å‹ç®—æ³•å·¥ç¨‹å¸ˆï¼Œæˆ‘æ·±å…¥ç ”ç©¶äº†è¿™å¥—æ–¹æ¡ˆï¼Œä»Šå¤©å°±æ¥ç»™å¤§å®¶è¯¦ç»†æ‹†è§£ï¼š

- **ä¸Šä¸‹æ–‡ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**
- **æœ‰å“ª6ç§ä¿®å¤æŠ€å·§ï¼Ÿ**
- **å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ï¼Ÿ**

æ–‡ç« è¾ƒé•¿ï¼Œå»ºè®®æ”¶è—æ…¢æ…¢çœ‹ã€‚Let's dive in! ğŸš€

---

## ä¸€ã€ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼Ÿ

æ­£å¦‚ Andrej Karpathy æ‰€è¯´ï¼Œ**ä¸Šä¸‹æ–‡å·¥ç¨‹æ˜¯ä¸€é—¨ç²¾å¦™çš„è‰ºæœ¯ä¸ç§‘å­¦â€”â€”åœ¨ä¸Šä¸‹æ–‡çª—å£ä¸­å¡«å……æ°åˆ°å¥½å¤„çš„ä¿¡æ¯ï¼Œä»¥æ”¯æŒä¸‹ä¸€æ­¥çš„æ¨ç†ã€‚**

å¬èµ·æ¥ç®€å•ï¼Œä½†å®é™…æ“ä½œä¸­ï¼Œéšç€ä¸Šä¸‹æ–‡çš„ä¸æ–­ç´¯ç§¯ï¼ˆå·¥å…·è°ƒç”¨ã€æ–‡æ¡£æ£€ç´¢ã€å¤šè½®å¯¹è¯ï¼‰ï¼Œä¸Šä¸‹æ–‡å¯èƒ½å˜å¾—ï¼š
- **æœ‰æ¯’**ï¼ˆpoisonedï¼‰ï¼šé”™è¯¯ä¿¡æ¯åå¤è¢«å¼•ç”¨
- **åˆ†æ•£æ³¨æ„åŠ›**ï¼ˆdistractingï¼‰ï¼šæ¨¡å‹è¿‡åº¦å…³æ³¨å†å²è€Œå¿½ç•¥è®­ç»ƒçŸ¥è¯†
- **æ··ä¹±**ï¼ˆconfusingï¼‰ï¼šæ— å…³ä¿¡æ¯å¹²æ‰°å†³ç­–
- **å†²çª**ï¼ˆclashingï¼‰ï¼šå†…éƒ¨ä¿¡æ¯è‡ªç›¸çŸ›ç›¾

ä¸‹é¢è¿™å¼ å›¾å®Œç¾æ€»ç»“äº†ä¸Šä¸‹æ–‡å·¥ç¨‹çš„æ ¸å¿ƒæŠ€å·§ï¼š

![1762235489139.png](https://youke1.picui.cn/s1/2025/11/04/6909943b0f6a9.png)

---

## äºŒã€ä¸Šä¸‹æ–‡çš„4ç§å¤±æ•ˆæ¨¡å¼

åœ¨ä»‹ç»è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦ç†è§£é—®é¢˜æœ¬è´¨ã€‚Drew Breunig æ€»ç»“äº†ä¸Šä¸‹æ–‡å¤±æ•ˆçš„4ç§å…¸å‹æ¨¡å¼ï¼š

### 2.1 ä¸Šä¸‹æ–‡ä¸­æ¯’ï¼ˆContext Poisoningï¼‰

**å®šä¹‰**ï¼šå½“å¹»è§‰æˆ–é”™è¯¯è¿›å…¥ä¸Šä¸‹æ–‡åï¼Œè¢«æ¨¡å‹åå¤å¼•ç”¨å’Œå¼ºåŒ–ã€‚

**æ¡ˆä¾‹**ï¼šDeepMind å›¢é˜Ÿåœ¨ Gemini 2.5 æŠ€æœ¯æŠ¥å‘Šä¸­æåˆ°ï¼Œä»–ä»¬è®© Gemini ç©å®å¯æ¢¦æ¸¸æˆæ—¶ï¼Œæ¨¡å‹å¶å°”ä¼šäº§ç”Ÿå¹»è§‰ã€‚ä¸€æ—¦"ç›®æ ‡"éƒ¨åˆ†è¢«æ±¡æŸ“ï¼ˆæ¯”å¦‚è®¤ä¸ºè‡ªå·±éœ€è¦å®Œæˆä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„ä»»åŠ¡ï¼‰ï¼Œæ™ºèƒ½ä½“å°±ä¼šåˆ¶å®šè’è°¬çš„ç­–ç•¥ï¼Œå¹¶ä¸æ–­é‡å¤æ— æ•ˆè¡Œä¸ºã€‚

**å±å®³**ï¼šæ¨¡å‹ä¼šæ‰§ç€äºå®ç°ä¸å¯èƒ½çš„ç›®æ ‡ï¼Œé™·å…¥æ­»å¾ªç¯ã€‚

### 2.2 ä¸Šä¸‹æ–‡å¹²æ‰°ï¼ˆContext Distractionï¼‰

**å®šä¹‰**ï¼šä¸Šä¸‹æ–‡è¿‡é•¿æ—¶ï¼Œæ¨¡å‹è¿‡åº¦å…³æ³¨å†å²è®°å½•ï¼Œå¿½ç•¥äº†è®­ç»ƒæ—¶å­¦åˆ°çš„çŸ¥è¯†ã€‚

**æ•°æ®æ”¯æŒ**ï¼š
- Gemini 2.5 Pro è™½ç„¶æ”¯æŒ 100 ä¸‡+ token çš„ä¸Šä¸‹æ–‡ï¼Œä½†å½“ä¸Šä¸‹æ–‡è¶…è¿‡ 10 ä¸‡ token æ—¶ï¼Œå°±å¼€å§‹å€¾å‘äºé‡å¤å†å²æ“ä½œï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ–°ç­–ç•¥
- Databricks ç ”ç©¶å‘ç°ï¼ŒLlama 3.1 405B çš„æ­£ç¡®ç‡åœ¨ 32k token å·¦å³å°±å¼€å§‹ä¸‹é™ï¼Œæ›´å°çš„æ¨¡å‹ä¸‹é™å¾—æ›´æ—©

**å¯ç¤º**ï¼šå³ä½¿æ¨¡å‹æ”¯æŒè¶…é•¿ä¸Šä¸‹æ–‡ï¼Œä¹Ÿä¸æ„å‘³ç€åº”è¯¥å…¨éƒ¨å¡«æ»¡ã€‚

### 2.3 ä¸Šä¸‹æ–‡æ··æ·†ï¼ˆContext Confusionï¼‰

**å®šä¹‰**ï¼šä¸Šä¸‹æ–‡ä¸­çš„å†—ä½™å†…å®¹è¢«æ¨¡å‹é”™è¯¯ä½¿ç”¨ï¼Œå¯¼è‡´ä½è´¨é‡å“åº”ã€‚

**å…¸å‹åœºæ™¯**ï¼šMCPï¼ˆModel Context Protocolï¼‰å·¥å…·è¿‡è½½ã€‚

**å®éªŒè¯æ®**ï¼š
- Berkeley Function-Calling Leaderboard æ˜¾ç¤ºï¼Œå½“æä¾›å¤šä¸ªå·¥å…·æ—¶ï¼Œ**æ‰€æœ‰æ¨¡å‹çš„è¡¨ç°éƒ½ä¼šä¸‹é™**
- ä¸€é¡¹ç ”ç©¶å‘ç°ï¼Œé‡åŒ–ç‰ˆ Llama 3.1 8B åœ¨é¢å¯¹ 46 ä¸ªå·¥å…·æ—¶å¤±è´¥ï¼Œä½†åªç»™ 19 ä¸ªå·¥å…·æ—¶å°±æˆåŠŸäº†â€”â€”å³ä½¿ä¸Šä¸‹æ–‡çª—å£è¿˜å¾ˆå……è£•

**æ ¸å¿ƒé—®é¢˜**ï¼šæ¨¡å‹ä¼šè¯•å›¾ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå³ä½¿å®ƒä»¬ä¸ä»»åŠ¡æ— å…³ã€‚

![gemma_irrelevance](https://www.dbreunig.com/img/gemma_irrelevance.png)

### 2.4 ä¸Šä¸‹æ–‡å†²çªï¼ˆContext Clashï¼‰

**å®šä¹‰**ï¼šä¸Šä¸‹æ–‡ä¸­ç´¯ç§¯çš„ä¿¡æ¯è‡ªç›¸çŸ›ç›¾ã€‚

**é‡ç£…ç ”ç©¶**ï¼šå¾®è½¯å’Œ Salesforce çš„è”åˆå›¢é˜Ÿåšäº†ä¸€ä¸ªå®éªŒï¼š
- æŠŠä¸€ä¸ªå®Œæ•´çš„æç¤ºè¯æ‹†åˆ†æˆå¤šè½®å¯¹è¯
- æ‰€æœ‰ä¿¡æ¯éƒ½ç›¸åŒï¼Œåªæ˜¯åˆ†é˜¶æ®µæä¾›
- ç»“æœï¼š**å¹³å‡æ€§èƒ½ä¸‹é™ 39%**
- ç”šè‡³ OpenAI çš„ o3 æ¨¡å‹å¾—åˆ†ä» 98.1 æš´è·Œåˆ° 64.1

![sharded_prompt](https://www.dbreunig.com/img/sharded_prompt.png)

**åŸå› **ï¼šæ—©æœŸçš„é”™è¯¯å›ç­”ä¼šç•™åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œå½±å“åç»­æ¨ç†ã€‚ç ”ç©¶å›¢é˜Ÿæ€»ç»“ï¼š
> "å½“ LLM åœ¨å¯¹è¯ä¸­èµ°é”™æ–¹å‘æ—¶ï¼Œå®ƒä»¬å°±ä¼šè¿·å¤±å¹¶æ— æ³•æ¢å¤ã€‚"

**å¯¹ Agent çš„å½±å“**ï¼šAgent éœ€è¦ä»æ–‡æ¡£ã€å·¥å…·è°ƒç”¨ã€å­ä»»åŠ¡ä¸­æ”¶é›†ä¸Šä¸‹æ–‡ï¼Œè¿™äº›æ¥è‡ªä¸åŒæ¥æºçš„ä¿¡æ¯æ›´å®¹æ˜“äº§ç”Ÿå†²çªã€‚

---

## ä¸‰ã€6å¤§ä¸Šä¸‹æ–‡ä¿®å¤æŠ€å·§

äº†è§£äº†é—®é¢˜ï¼Œç°åœ¨æ¥çœ‹è§£å†³æ–¹æ¡ˆã€‚è¿™6ç§æŠ€å·§ç¯ç¯ç›¸æ‰£ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆåº”ç”¨ã€‚

### æŠ€å·§1ï¼šRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰

![RAG](https://www.dbreunig.com/img/rag.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šé€‰æ‹©æ€§åœ°æ·»åŠ ç›¸å…³ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¸€è‚¡è„‘å…¨å¡è¿›å»ã€‚

**ç°çŠ¶**ï¼šæ¯å½“æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æ‰©å¤§ï¼Œå°±æœ‰äººå–Š"RAG å·²æ­»"ã€‚Llama 4 Scout æ¨å‡º 1000 ä¸‡ token çª—å£æ—¶ï¼Œè¿™ç§å£°éŸ³å°¤å…¶å“äº®ã€‚

**äº‹å®**ï¼šRAG ä¸ä»…æ²¡æ­»ï¼Œåè€Œæ›´é‡è¦äº†ï¼

- å¦‚æœæŠŠä¸Šä¸‹æ–‡å½“ä½œ"æ‚ç‰©æŠ½å±‰"ï¼Œæ‚ç‰©ä¼šå½±å“æ¨¡å‹å“åº”
- å³ä½¿æœ‰è¶…å¤§çª—å£ï¼Œç²¾å‡†æ£€ç´¢ä¾ç„¶æ˜¯æå‡è´¨é‡çš„å…³é”®
- RAG çš„æœ¬è´¨æ˜¯**ä¿¡æ¯ç®¡ç†**ï¼Œè€Œä¸æ˜¯çª—å£å¤§å°é—®é¢˜

**å®ç°è¦ç‚¹**ï¼ˆåŸºäº LangGraphï¼‰ï¼š
- æ–‡æ¡£åˆ‡å—ï¼šä½¿ç”¨ RecursiveCharacterTextSplitter
- å‘é‡å­˜å‚¨ï¼šOpenAI Embeddings
- æ™ºèƒ½æ£€ç´¢ï¼šå…ˆæ˜ç¡®ç ”ç©¶èŒƒå›´ï¼Œå†æ‰§è¡Œæ£€ç´¢
- æ€§èƒ½ï¼šå¤æ‚æŸ¥è¯¢çº¦æ¶ˆè€— 25k tokensï¼ˆå«å·¥å…·è°ƒç”¨ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from langchain_community.document_loaders import WebBaseLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_openai import OpenAIEmbeddings
from langchain_chroma import Chroma
from langchain.tools.retriever import create_retriever_tool

# 1. åŠ è½½å¹¶åˆ‡åˆ†æ–‡æ¡£
loader = WebBaseLoader("https://lilianweng.github.io/posts/2023-06-23-agent/")
docs = loader.load()
text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)
documents = text_splitter.split_documents(docs)

# 2. åˆ›å»ºå‘é‡å­˜å‚¨
embeddings = OpenAIEmbeddings()
vectorstore = Chroma.from_documents(documents, embeddings)
retriever = vectorstore.as_retriever(search_kwargs={"k": 5})

# 3. å°è£…ä¸ºå·¥å…·
retriever_tool = create_retriever_tool(
    retriever,
    "retrieve_blog_posts",
    "æœç´¢å¹¶è¿”å› Lilian Weng å…³äº AI Agent çš„åšå®¢æ–‡ç« ç‰‡æ®µ"
)

# 4. åœ¨ LangGraph ä¸­ä½¿ç”¨
from langgraph.prebuilt import create_react_agent
from langchain_anthropic import ChatAnthropic

llm = ChatAnthropic(model="claude-sonnet-4-20250514")
agent = create_react_agent(llm, [retriever_tool])

# æ‰§è¡ŒæŸ¥è¯¢
result = agent.invoke({
    "messages": [("user", "ä»€ä¹ˆæ˜¯ reward hackingï¼Ÿç»™æˆ‘è¯¦ç»†è§£é‡Š")]
})
```

**å…³é”®ç‚¹**ï¼šæ¨¡å‹ä¼šå…ˆè°ƒç”¨æ£€ç´¢å·¥å…·è·å–ç›¸å…³æ–‡æ¡£ç‰‡æ®µï¼Œå†åŸºäºè¿™äº›ç‰‡æ®µç”Ÿæˆç­”æ¡ˆï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰æ–‡æ¡£å¡è¿›ä¸Šä¸‹æ–‡ã€‚

---

### æŠ€å·§2ï¼šå·¥å…·è£…è½½ï¼ˆTool Loadoutï¼‰

![Tool Loadout](https://www.dbreunig.com/img/tool_loadout.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šåªåŠ è½½ä¸ä»»åŠ¡ç›¸å…³çš„å·¥å…·å®šä¹‰ã€‚

**æœ¯è¯­æ¥æº**ï¼š"Loadout"æ˜¯æ¸¸æˆæœ¯è¯­ï¼ŒæŒ‡å¼€å±€å‰é€‰æ‹©çš„æŠ€èƒ½ã€æ­¦å™¨å’Œè£…å¤‡ç»„åˆâ€”â€”æ ¹æ®å…³å¡ã€é˜Ÿå‹å’Œè‡ªèº«èƒ½åŠ›é‡èº«å®šåˆ¶ã€‚

**å…³é”®ç ”ç©¶**ï¼š
- **RAG MCP è®ºæ–‡**ï¼šç”¨å‘é‡æ•°æ®åº“å­˜å‚¨å·¥å…·æè¿°ï¼Œæ ¹æ®æç¤ºè¯æ£€ç´¢ç›¸å…³å·¥å…·
- **æµ‹è¯•å‘ç°**ï¼šå¯¹äº DeepSeek-v3ï¼Œå·¥å…·è¶…è¿‡ 30 ä¸ªæ—¶ï¼Œæè¿°å¼€å§‹é‡å é€ æˆæ··æ·†ï¼›è¶…è¿‡ 100 ä¸ªå‡ ä¹å¿…ç„¶å¤±è´¥
- **æ•ˆæœ**ï¼šåŠ¨æ€é€‰æ‹©å°‘äº 30 ä¸ªå·¥å…·ï¼Œå·¥å…·é€‰æ‹©å‡†ç¡®ç‡æå‡ **3å€**

**"Less is More"ç ”ç©¶**ï¼š
- ä½¿ç”¨ LLM é©±åŠ¨çš„å·¥å…·æ¨èå™¨ï¼Œè®©æ¨¡å‹å…ˆæ¨ç†"éœ€è¦å“ªäº›å·¥å…·"
- å†é€šè¿‡è¯­ä¹‰æœç´¢ç¡®å®šæœ€ç»ˆå·¥å…·é›†
- Llama 3.1 8B æ€§èƒ½æå‡ **44%**
- å³ä½¿å‡†ç¡®ç‡ä¸å˜ï¼ŒåŠŸè€—é™ä½ 18%ï¼Œé€Ÿåº¦æå‡ 77%ï¼ˆè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼‰

**å®è·µå»ºè®®**ï¼š
- å°å‹ Agent æ‰‹å·¥ç²¾é€‰å°‘é‡å·¥å…·å³å¯
- å¤§å‹ç³»ç»Ÿå¿…é¡»å®ç°åŠ¨æ€å·¥å…·é€‰æ‹©
- è¾¹ç¼˜è®¾å¤‡å°¤å…¶è¦æ³¨æ„å·¥å…·æ•°é‡ï¼ˆåŠŸè€—å’Œé€Ÿåº¦ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```python
import math
from langchain_openai import OpenAIEmbeddings
from langchain_chroma import Chroma
from langchain.tools import tool

# 1. å®šä¹‰å·¥å…·æ± ï¼ˆä»¥ math åº“ä¸ºä¾‹ï¼‰
@tool
def add(a: float, b: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œ"""
    return math.add(a, b)

@tool
def multiply(a: float, b: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯"""
    return math.multiply(a, b)

# ... å®šä¹‰æ›´å¤šå·¥å…·

all_tools = [add, multiply, ...]  # å‡è®¾æœ‰ 50+ ä¸ªå·¥å…·

# 2. ä¸ºæ¯ä¸ªå·¥å…·åˆ›å»ºæè¿°å’Œç´¢å¼•
tool_descriptions = [
    f"åç§°: {tool.name}\næè¿°: {tool.description}" 
    for tool in all_tools
]

embeddings = OpenAIEmbeddings()
vectorstore = Chroma.from_texts(tool_descriptions, embeddings)

# 3. æ ¹æ®ç”¨æˆ·æŸ¥è¯¢åŠ¨æ€é€‰æ‹©å·¥å…·
def select_relevant_tools(query: str, top_k: int = 5):
    # è¯­ä¹‰æœç´¢æœ€ç›¸å…³çš„å·¥å…·
    docs = vectorstore.similarity_search(query, k=top_k)
    tool_indices = [int(doc.metadata['index']) for doc in docs]
    return [all_tools[i] for i in tool_indices]

# 4. ä½¿ç”¨é€‰å®šçš„å·¥å…·
user_query = "æˆ‘éœ€è¦è®¡ç®—ä¸€äº›æ•°å­¦è¿ç®—"
selected_tools = select_relevant_tools(user_query, top_k=5)

# åªç»‘å®šç›¸å…³å·¥å…·ï¼Œé¿å…ä¸Šä¸‹æ–‡æ··æ·†
agent = create_react_agent(llm, selected_tools)
```

**å…³é”®ç‚¹**ï¼šå·¥å…·æ•°é‡ä» 50+ é™åˆ° 5 ä¸ªï¼Œä¸Šä¸‹æ–‡æ›´æ¸…æ™°ï¼Œå·¥å…·é€‰æ‹©å‡†ç¡®ç‡æå‡ 3 å€ï¼Œé€Ÿåº¦å’ŒåŠŸè€—éƒ½å¤§å¹…ä¼˜åŒ–ã€‚

---

### æŠ€å·§3ï¼šä¸Šä¸‹æ–‡éš”ç¦»ï¼ˆContext Quarantineï¼‰

![Context Quarantine](https://www.dbreunig.com/img/context_quarantine.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠä»»åŠ¡æ‹†åˆ†åˆ°ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ã€‚

**æœ€ä½³æ¡ˆä¾‹**ï¼šAnthropic çš„å¤šæ™ºèƒ½ä½“ç ”ç©¶ç³»ç»Ÿ

Anthropic å›¢é˜Ÿåœ¨åšå®¢ä¸­è¯¦ç»†ä»‹ç»äº†ä»–ä»¬çš„æ¶æ„ï¼š
> "æœç´¢çš„æœ¬è´¨æ˜¯å‹ç¼©ï¼šä»åºå¤§è¯­æ–™åº“ä¸­æç‚¼æ´å¯Ÿã€‚å­æ™ºèƒ½ä½“é€šè¿‡å¹¶è¡Œè¿è¡Œäºå„è‡ªçš„ä¸Šä¸‹æ–‡çª—å£æ¥ä¿ƒè¿›å‹ç¼©ï¼ŒåŒæ—¶æ¢ç´¢é—®é¢˜çš„ä¸åŒæ–¹é¢ã€‚"

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šæ¯ä¸ªå­æ™ºèƒ½ä½“æœ‰ä¸“å±å·¥å…·ã€æç¤ºå’Œæ¢ç´¢è·¯å¾„
- **é™ä½è·¯å¾„ä¾èµ–**ï¼šç‹¬ç«‹è°ƒæŸ¥ï¼Œäº’ä¸å¹²æ‰°
- **å¤§å¹…æå‡æ€§èƒ½**ï¼šClaude Opus 4ï¼ˆä¸»æ™ºèƒ½ä½“ï¼‰+ Claude Sonnet 4ï¼ˆå­æ™ºèƒ½ä½“ï¼‰çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼Œæ¯”å•æ™ºèƒ½ä½“ Opus 4 æ€§èƒ½æå‡ **90.2%**

**å…¸å‹åœºæ™¯**ï¼šå¹¿åº¦ä¼˜å…ˆæœç´¢

ä¾‹å¦‚ï¼š"æ‰¾å‡ºæ ‡æ™® 500 ä¿¡æ¯æŠ€æœ¯æ¿å—æ‰€æœ‰å…¬å¸çš„è‘£äº‹ä¼šæˆå‘˜"
- å•æ™ºèƒ½ä½“ï¼šç¼“æ…¢çš„é¡ºåºæœç´¢ï¼Œå®¹æ˜“å¤±è´¥
- å¤šæ™ºèƒ½ä½“ï¼šæ‹†è§£ä»»åŠ¡ç»™å­æ™ºèƒ½ä½“ï¼Œå¹¶è¡Œå¤„ç†ï¼ŒæˆåŠŸç‡é«˜

**å®ç°è¦ç‚¹**ï¼š
- è®¾è®¡ä¸åŒç±»å‹çš„æ™ºèƒ½ä½“ï¼ˆç ”ç©¶å‹ã€è®¡ç®—å‹ã€åˆ†æå‹ç­‰ï¼‰
- æ¯ä¸ªæ™ºèƒ½ä½“æœ‰ä¸“å±å·¥å…·é›†å’Œæç¤ºè¯
- ä¸»æ™ºèƒ½ä½“è´Ÿè´£ä»»åŠ¡åˆ†é…å’Œç»“æœæ±‡æ€»
- é€‚åˆå¯å¹¶è¡ŒåŒ–çš„é—®é¢˜

**å±€é™**ï¼šä¸é€‚åˆéœ€è¦å¤šæ™ºèƒ½ä½“é¢‘ç¹å…±äº«ä¸Šä¸‹æ–‡çš„åœºæ™¯ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.prebuilt import create_react_agent
from langchain_anthropic import ChatAnthropic
from langchain.tools import tool

# 1. å®šä¹‰ä¸“å®¶æ™ºèƒ½ä½“çš„å·¥å…·
@tool
def multiply(a: float, b: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯"""
    return a * b

@tool
def add(a: float, b: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œ"""
    return a + b

@tool
def web_search(query: str) -> str:
    """æ‰§è¡Œç½‘é¡µæœç´¢"""
    # å®é™…å®ç°ä¼šè°ƒç”¨æœç´¢ API
    return f"æœç´¢ç»“æœ: {query}"

# 2. åˆ›å»ºä¸“å®¶æ™ºèƒ½ä½“ï¼ˆå„è‡ªç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ï¼‰
math_agent = create_react_agent(
    ChatAnthropic(model="claude-sonnet-4-20250514"),
    tools=[add, multiply],
    state_modifier="ä½ æ˜¯æ•°å­¦ä¸“å®¶ï¼Œä¸“æ³¨äºè®¡ç®—ä»»åŠ¡ã€‚"
)

research_agent = create_react_agent(
    ChatAnthropic(model="claude-sonnet-4-20250514"),
    tools=[web_search],
    state_modifier="ä½ æ˜¯ç ”ç©¶ä¸“å®¶ï¼Œä¸“æ³¨äºä¿¡æ¯æœç´¢å’Œåˆ†æã€‚"
)

# 3. åˆ›å»º Supervisor èŠ‚ç‚¹
def supervisor(state: MessagesState):
    """ä¸»æ™ºèƒ½ä½“ï¼šè·¯ç”±ä»»åŠ¡åˆ°åˆé€‚çš„ä¸“å®¶"""
    llm = ChatAnthropic(model="claude-opus-4-20250514")
    
    system_prompt = """ä½ æ˜¯ä»»åŠ¡åè°ƒå‘˜ã€‚åˆ†æç”¨æˆ·è¯·æ±‚ï¼š
    - å¦‚æœæ¶‰åŠæ•°å­¦è®¡ç®—ï¼Œè°ƒç”¨ 'math_expert'
    - å¦‚æœéœ€è¦æœç´¢ä¿¡æ¯ï¼Œè°ƒç”¨ 'research_expert'
    - å¦‚æœä»»åŠ¡å®Œæˆï¼Œè¿”å› 'FINISH'
    """
    
    # åˆ†æå¹¶è·¯ç”±
    response = llm.invoke([system_prompt] + state["messages"])
    return {"next": response.tool_calls[0]["name"] if response.tool_calls else "FINISH"}

# 4. æ„å»ºå¤šæ™ºèƒ½ä½“å›¾
workflow = StateGraph(MessagesState)
workflow.add_node("supervisor", supervisor)
workflow.add_node("math_expert", math_agent)
workflow.add_node("research_expert", research_agent)

workflow.add_edge(START, "supervisor")
workflow.add_conditional_edges(
    "supervisor",
    lambda x: x["next"],
    {
        "math_expert": "math_expert",
        "research_expert": "research_expert",
        "FINISH": END
    }
)

app = workflow.compile()

# 5. æ‰§è¡Œä»»åŠ¡
result = app.invoke({
    "messages": [("user", "å¸®æˆ‘æœç´¢é‡å­è®¡ç®—çš„æœ€æ–°è¿›å±•ï¼Œç„¶åè®¡ç®— 123 * 456")]
})
```

**å…³é”®ç‚¹**ï¼šæ¯ä¸ªä¸“å®¶æ™ºèƒ½ä½“åœ¨ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ä¸­å·¥ä½œï¼Œäº’ä¸å¹²æ‰°ã€‚Supervisor è´Ÿè´£ä»»åŠ¡åˆ†è§£å’Œç»“æœæ±‡æ€»ï¼Œæ€§èƒ½æå‡ 90.2%ã€‚

---

### æŠ€å·§4ï¼šä¸Šä¸‹æ–‡ä¿®å‰ªï¼ˆContext Pruningï¼‰

![Context Pruning](https://www.dbreunig.com/img/context_pruning.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ é™¤ä¸Šä¸‹æ–‡ä¸­ä¸ç›¸å…³æˆ–ä¸å¿…è¦çš„ä¿¡æ¯ã€‚

**åº”ç”¨åœºæ™¯**ï¼šAgent åœ¨è°ƒç”¨å·¥å…·å’Œæ”¶é›†æ–‡æ¡£æ—¶ä¼šä¸æ–­ç§¯ç´¯ä¸Šä¸‹æ–‡ï¼Œå®šæœŸä¿®å‰ªå¯ä»¥å»é™¤å†—ä½™ã€‚

**æ¨èå·¥å…·**ï¼šProvence

Provence æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„é—®ç­”ç³»ç»Ÿä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ï¼š
- **æ¨¡å‹å¤§å°**ï¼šä»… 1.75 GB
- **é€Ÿåº¦**ï¼šå¿«é€Ÿ
- **å‡†ç¡®æ€§**ï¼šé«˜
- **æ˜“ç”¨æ€§**ï¼šå‡ è¡Œä»£ç æå®š

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
from transformers import AutoModel

provence = AutoModel.from_pretrained(
    "naver/provence-reranker-debertav3-v1", 
    trust_remote_code=True
)

# è¯»å–ç»´åŸºç™¾ç§‘æ¡ç›®
with open('alameda_wiki.md', 'r', encoding='utf-8') as f:
    alameda_wiki = f.read()

# æ ¹æ®é—®é¢˜ä¿®å‰ªæ–‡ç« 
question = 'What are my options for leaving Alameda?'
provence_output = provence.process(question, alameda_wiki)
```

**æ•ˆæœ**ï¼šå¯ä»¥åˆ å‡ **95%** çš„å†…å®¹ï¼Œåªä¿ç•™ç›¸å…³éƒ¨åˆ†ã€‚

**æ¶æ„å»ºè®®**ï¼š
- ä½¿ç”¨å­—å…¸æˆ–ç»“æ„åŒ–æ•°æ®ç»´æŠ¤ä¸Šä¸‹æ–‡
- åœ¨æ¯æ¬¡ LLM è°ƒç”¨å‰ç»„è£…æˆå­—ç¬¦ä¸²
- ä¿®å‰ªæ—¶ä¿æŠ¤æ ¸å¿ƒæŒ‡ä»¤å’Œç›®æ ‡
- å¯é€‰æ‹©æ€§ä¿®å‰ªæ–‡æ¡£æˆ–å†å²è®°å½•éƒ¨åˆ†

**æ€§èƒ½æå‡**ï¼š
- æŸæ¡ˆä¾‹ä¸­ï¼Œä» 25k tokensï¼ˆRAGï¼‰é™è‡³ **11k tokens**ï¼ˆRAG + ä¿®å‰ªï¼‰
- ç­”æ¡ˆè´¨é‡ä¸å˜

---

### æŠ€å·§5ï¼šä¸Šä¸‹æ–‡æ‘˜è¦ï¼ˆContext Summarizationï¼‰

![Context Summarization](https://www.dbreunig.com/img/context_summarization.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†ç´¯ç§¯çš„ä¸Šä¸‹æ–‡æµ“ç¼©æˆç®€æ´æ‘˜è¦ã€‚

**å†å²æ¸Šæº**ï¼šæœ€åˆæ˜¯ä¸ºäº†åº”å¯¹å°ä¸Šä¸‹æ–‡çª—å£è€Œç”Ÿâ€”â€”å¿«åˆ°ä¸Šé™æ—¶ï¼Œç”Ÿæˆæ‘˜è¦å¹¶å¼€å¯æ–°å¯¹è¯ã€‚ç”¨æˆ·åœ¨ ChatGPT/Claude ä¸­æ‰‹åŠ¨æ“ä½œè¿‡ã€‚

**æ–°å‘ç°**ï¼šå³ä½¿çª—å£å¤Ÿå¤§ï¼Œæ‘˜è¦ä¾ç„¶æœ‰ä»·å€¼ï¼

å›é¡¾ Gemini å›¢é˜Ÿçš„å‘ç°ï¼š
> "å½“ä¸Šä¸‹æ–‡è¶…è¿‡ 10 ä¸‡ tokens æ—¶ï¼Œæ™ºèƒ½ä½“å€¾å‘äºé‡å¤å†å²æ“ä½œï¼Œè€Œéç”Ÿæˆæ–°ç­–ç•¥ã€‚"

è¿™å°±æ˜¯**ä¸Šä¸‹æ–‡å¹²æ‰°**çš„å…¸å‹è¡¨ç°ã€‚

**å®ç°éš¾ç‚¹**ï¼š
- **å®¹æ˜“åšï¼Œéš¾åšå¥½**ï¼šå…³é”®åœ¨äºåˆ¤æ–­å“ªäº›ä¿¡æ¯åº”è¯¥ä¿ç•™
- **éœ€è¦ç»†è‡´è°ƒä¼˜**ï¼šé’ˆå¯¹ç‰¹å®š Agent å®šåˆ¶æ‘˜è¦ç­–ç•¥
- **å»ºè®®**ï¼šæŠŠæ‘˜è¦åŠŸèƒ½ç‹¬ç«‹å‡ºæ¥ï¼Œä½œä¸ºä¸“é—¨çš„ LLM é©±åŠ¨é˜¶æ®µï¼Œæ–¹ä¾¿æ”¶é›†è¯„ä¼°æ•°æ®å’Œä¼˜åŒ–

**æ¨¡å‹é€‰æ‹©**ï¼š
- ä½¿ç”¨æˆæœ¬æ›´ä½çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4o-miniï¼‰è¿›è¡Œæ‘˜è¦
- ç›®æ ‡ï¼šå‹ç¼© 50-70% çš„é•¿åº¦ï¼Œä¿ç•™æ‰€æœ‰å…³é”®ä¿¡æ¯

**vs ä¿®å‰ª**ï¼š
- **ä¿®å‰ª**ï¼šåˆ é™¤æ— å…³å†…å®¹
- **æ‘˜è¦**ï¼šå‹ç¼©æ‰€æœ‰ä¿¡æ¯ï¼ˆé€‚åˆå†…å®¹éƒ½ç›¸å…³ä½†å†—é•¿çš„åœºæ™¯ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from typing import TypedDict
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic

class AgentState(TypedDict):
    messages: list
    tool_results: str  # å·¥å…·è°ƒç”¨çš„åŸå§‹ç»“æœ
    summary: str       # æ‘˜è¦åçš„ç»“æœ

def tool_call_node(state: AgentState):
    """æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨ï¼Œè¿”å›é•¿æ–‡æœ¬"""
    # å‡è®¾è¿™æ˜¯ä¸€ä¸ªæ£€ç´¢åˆ°çš„é•¿æ–‡æ¡£
    long_document = """
    [æ­¤å¤„æ˜¯ 5000 å­—çš„æ£€ç´¢æ–‡æ¡£å†…å®¹...]
    åŒ…å«å¤§é‡ç»†èŠ‚ã€æ¡ˆä¾‹ã€å¼•ç”¨ç­‰ä¿¡æ¯...
    """
    return {"tool_results": long_document}

def summarize_node(state: AgentState):
    """æ‘˜è¦èŠ‚ç‚¹ï¼šå‹ç¼©å·¥å…·ç»“æœ"""
    summarizer = ChatOpenAI(model="gpt-4o-mini")
    
    prompt = f"""è¯·å°†ä»¥ä¸‹å†…å®¹å‹ç¼©ä¸ºç®€æ´æ‘˜è¦ï¼Œä¿ç•™æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼š

è¦æ±‚ï¼š
1. å‹ç¼©åˆ°åŸé•¿åº¦çš„ 30-50%
2. ä¿ç•™æ ¸å¿ƒè®ºç‚¹ã€å…³é”®æ•°æ®å’Œé‡è¦ç»“è®º
3. åˆ é™¤å†—ä½™æè¿°å’Œé‡å¤å†…å®¹
4. ä¿æŒä¿¡æ¯å®Œæ•´æ€§

åŸæ–‡ï¼š
{state['tool_results']}

æ‘˜è¦ï¼š"""
    
    response = summarizer.invoke(prompt)
    return {"summary": response.content}

def respond_node(state: AgentState):
    """åŸºäºæ‘˜è¦ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ"""
    llm = ChatAnthropic(model="claude-sonnet-4-20250514")
    
    # ä½¿ç”¨æ‘˜è¦è€ŒéåŸå§‹é•¿æ–‡æ¡£
    prompt = f"""åŸºäºä»¥ä¸‹æ‘˜è¦ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ï¼š

æ‘˜è¦ï¼š
{state['summary']}

ç”¨æˆ·é—®é¢˜ï¼š
{state['messages'][-1]['content']}
"""
    
    response = llm.invoke(prompt)
    return {"messages": state["messages"] + [{"role": "assistant", "content": response.content}]}

# æ„å»ºå·¥ä½œæµ
workflow = StateGraph(AgentState)
workflow.add_node("tool_call", tool_call_node)
workflow.add_node("summarize", summarize_node)
workflow.add_node("respond", respond_node)

workflow.add_edge(START, "tool_call")
workflow.add_edge("tool_call", "summarize")
workflow.add_edge("summarize", "respond")
workflow.add_edge("respond", END)

app = workflow.compile()

# æ‰§è¡Œ
result = app.invoke({
    "messages": [{"role": "user", "content": "è§£é‡Šä¸€ä¸‹å¼ºåŒ–å­¦ä¹ ä¸­çš„ reward hacking"}]
})
```

**å…³é”®ç‚¹**ï¼šé€šè¿‡æ‘˜è¦å°† 5000 å­—å‹ç¼©åˆ° 1500-2500 å­—ï¼Œä¸Šä¸‹æ–‡æ¸…æ™°ï¼Œç­”æ¡ˆè´¨é‡ä¸å˜ï¼Œæˆæœ¬é™ä½ 50-70%ã€‚

---

### æŠ€å·§6ï¼šä¸Šä¸‹æ–‡å¸è½½ï¼ˆContext Offloadingï¼‰

![Context Offload](https://www.dbreunig.com/img/context_offload.png)

**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠä¿¡æ¯å­˜å‚¨åˆ° LLM ä¸Šä¸‹æ–‡ä¹‹å¤–ï¼Œé€šå¸¸é€šè¿‡å·¥å…·ç®¡ç†ã€‚

**ä¸ªäººæœ€çˆ±**ï¼šè¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„æŠ€å·§ï¼Œå› ä¸ºå®ƒ**ç®€å•åˆ°ä½ ä¸æ•¢ç›¸ä¿¡å®ƒæœ‰æ•ˆ**ã€‚

**Anthropic çš„ "think" å·¥å…·**

Anthropic å‘å¸ƒäº†è¯¦ç»†çš„æŠ€æœ¯åšå®¢ï¼Œä»‹ç»ä»–ä»¬çš„"think"å·¥å…·ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªè‰ç¨¿æœ¬ï¼‰ï¼š

> "æˆ‘ä»¬ç»™ Claude æä¾›äº†ä¸€ä¸ªé¢å¤–çš„æ€è€ƒæ­¥éª¤â€”â€”é…æœ‰ä¸“å±ç©ºé—´â€”â€”ä½œä¸ºå¾—å‡ºæœ€ç»ˆç­”æ¡ˆçš„ä¸€éƒ¨åˆ†â€¦â€¦è¿™åœ¨æ‰§è¡Œé•¿å·¥å…·è°ƒç”¨é“¾æˆ–å¤šæ­¥éª¤å¯¹è¯æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚"

**å°åæ§½**ï¼šè¿™ä¸ªå·¥å…·åº”è¯¥å« `scratchpad`ï¼ˆè‰ç¨¿æœ¬ï¼‰æ›´ç›´è§‚ï¼ä¸€å¬å°±çŸ¥é“åŠŸèƒ½â€”â€”è®©æ¨¡å‹è®°ç¬”è®°ï¼Œä¸æ±¡æŸ“ä¸»ä¸Šä¸‹æ–‡ï¼Œä¸”ä¾¿äºåç»­å‚è€ƒã€‚"think"è¿™ä¸ªåå­—å®¹æ˜“å’Œ"æ‰©å±•æ€è€ƒ"æ··æ·†ï¼Œè¿˜ä¸å¿…è¦åœ°æ‹ŸäººåŒ–äº†â€¦â€¦

**æ•ˆæœ**ï¼š
- é…åˆé¢†åŸŸç‰¹å®šæç¤ºè¯ï¼Œæ€§èƒ½æå‡é«˜è¾¾ **54%**

**ä¸‰å¤§é€‚ç”¨åœºæ™¯**ï¼š

1. **å·¥å…·è¾“å‡ºåˆ†æ**ï¼šéœ€è¦ä»”ç»†å¤„ç†å·¥å…·è°ƒç”¨ç»“æœï¼Œå¯èƒ½éœ€è¦å›æº¯
2. **æ”¿ç­–å¯†é›†ç¯å¢ƒ**ï¼šéœ€è¦éµå¾ªè¯¦ç»†æŒ‡å—å¹¶éªŒè¯åˆè§„æ€§
3. **é¡ºåºå†³ç­–**ï¼šæ¯ä¸ªåŠ¨ä½œå»ºç«‹åœ¨å‰ä¸€ä¸ªåŸºç¡€ä¸Šï¼Œé”™è¯¯ä»£ä»·é«˜ï¼ˆå¤šæ­¥éª¤ä»»åŠ¡ï¼‰

**ä¸¤ç§å­˜å‚¨æ¨¡å¼**ï¼ˆLangGraph å®ç°ï¼‰ï¼š

**æ¨¡å¼1ï¼šä¼šè¯è‰ç¨¿æœ¬**
- ä¸´æ—¶å­˜å‚¨ï¼Œä»…åœ¨å•æ¬¡å¯¹è¯ä¸­æœ‰æ•ˆ
- å·¥å…·ï¼š`WriteToScratchpad`ã€`ReadFromScratchpad`
- é€‚åˆï¼šå•æ¬¡ä»»åŠ¡çš„ä¸­é—´ç»“æœ

**æ¨¡å¼2ï¼šæŒä¹…åŒ–å†…å­˜**
- ä½¿ç”¨ `InMemoryStore` è·¨çº¿ç¨‹å­˜å‚¨
- æ”¯æŒå‘½åç©ºé—´çš„é”®å€¼å¯¹
- é€‚åˆï¼šéœ€è¦è·¨å¤šæ¬¡ä¼šè¯è®¿é—®çš„ç ”ç©¶æˆæœã€ç”¨æˆ·åå¥½ç­‰

**ç±»æ¯”**ï¼šç±»ä¼¼ ChatGPT çš„"è®°å¿†"åŠŸèƒ½å’Œ Anthropic å¤šæ™ºèƒ½ä½“ç ”ç©¶ç³»ç»Ÿçš„çŸ¥è¯†ç§¯ç´¯æœºåˆ¶ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from typing import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.store.memory import InMemoryStore
from langchain_anthropic import ChatAnthropic
from langchain.tools import tool

# 1. å®šä¹‰å¸¦è‰ç¨¿æœ¬çš„çŠ¶æ€
class AgentState(TypedDict):
    messages: list
    scratchpad: str  # è‰ç¨¿æœ¬ï¼Œå­˜å‚¨ä¸­é—´æ€è€ƒ

# 2. å®šä¹‰è‰ç¨¿æœ¬å·¥å…·
@tool
def write_to_scratchpad(content: str) -> str:
    """å°†å†…å®¹å†™å…¥è‰ç¨¿æœ¬"""
    return f"å·²è®°å½•: {content}"

@tool
def read_from_scratchpad() -> str:
    """ä»è‰ç¨¿æœ¬è¯»å–å†…å®¹"""
    return "è‰ç¨¿æœ¬å†…å®¹: [ä¹‹å‰è®°å½•çš„ä¿¡æ¯]"

# 3. åˆ›å»ºæ™ºèƒ½ä½“èŠ‚ç‚¹
def agent_node(state: AgentState):
    llm = ChatAnthropic(model="claude-sonnet-4-20250514")
    
    system_prompt = """ä½ æœ‰ä¸€ä¸ªè‰ç¨¿æœ¬å·¥å…·å¯ä»¥ä½¿ç”¨ï¼š
    - write_to_scratchpad: è®°å½•ä¸­é—´æ€è€ƒã€è®¡åˆ’ã€å‘ç°
    - read_from_scratchpad: æŸ¥çœ‹ä¹‹å‰è®°å½•çš„å†…å®¹
    
    å¯¹äºå¤æ‚ä»»åŠ¡ï¼š
    1. å…ˆå°†é—®é¢˜åˆ†è§£å†™å…¥è‰ç¨¿æœ¬
    2. æ‰§è¡Œæ­¥éª¤æ—¶è®°å½•è¿›åº¦
    3. éœ€è¦æ—¶è¯»å–ä¹‹å‰çš„è®°å½•
    
    è¿™æ ·ä¸»ä¸Šä¸‹æ–‡ä¿æŒç®€æ´ï¼Œé‡è¦ä¿¡æ¯ä¸ä¼šä¸¢å¤±ã€‚"""
    
    tools = [write_to_scratchpad, read_from_scratchpad]
    agent = create_react_agent(llm, tools, state_modifier=system_prompt)
    
    return agent.invoke(state)

# 4. æŒä¹…åŒ–å†…å­˜å­˜å‚¨ï¼ˆè·¨ä¼šè¯ï¼‰
store = InMemoryStore()

def save_to_memory(user_id: str, key: str, value: str):
    """ä¿å­˜åˆ°æŒä¹…åŒ–å†…å­˜"""
    namespace = ("users", user_id)
    store.put(namespace, key, {"content": value})

def load_from_memory(user_id: str, key: str) -> str:
    """ä»æŒä¹…åŒ–å†…å­˜è¯»å–"""
    namespace = ("users", user_id)
    item = store.get(namespace, key)
    return item.value["content"] if item else None

# 5. ä½¿ç”¨ç¤ºä¾‹
workflow = StateGraph(AgentState)
workflow.add_node("agent", agent_node)
workflow.add_edge(START, "agent")
workflow.add_edge("agent", END)

app = workflow.compile()

# ä¼šè¯1ï¼šç ”ç©¶ä»»åŠ¡
result1 = app.invoke({
    "messages": [("user", "å¸®æˆ‘ç ”ç©¶é‡å­è®¡ç®—çš„æœ€æ–°è¿›å±•ï¼Œè¿™æ˜¯ä¸ªå¤šæ­¥éª¤ä»»åŠ¡")]
})

# æ™ºèƒ½ä½“ä¼šä½¿ç”¨è‰ç¨¿æœ¬è®°å½•ï¼š
# - ç ”ç©¶è®¡åˆ’
# - å·²æœç´¢çš„å…³é”®è¯
# - é‡è¦å‘ç°
# - å¾…æ·±å…¥çš„æ–¹å‘

# ä¼šè¯2ï¼šç»§ç»­ç ”ç©¶ï¼ˆè·¨ä¼šè¯è®°å¿†ï¼‰
save_to_memory("user123", "quantum_research", "ä¸Šæ¬¡ç ”ç©¶äº†é‡å­çº ç¼ å’Œé‡å­é—¨")

previous_work = load_from_memory("user123", "quantum_research")
result2 = app.invoke({
    "messages": [("user", f"ç»§ç»­ä¸Šæ¬¡çš„ç ”ç©¶ã€‚ä¸Šæ¬¡å†…å®¹ï¼š{previous_work}")]
})
```

**å…³é”®ç‚¹**ï¼š
- è‰ç¨¿æœ¬è®©ä¸»ä¸Šä¸‹æ–‡ä¿æŒç®€æ´ï¼Œæ€§èƒ½æå‡ 54%
- æŒä¹…åŒ–å†…å­˜æ”¯æŒè·¨ä¼šè¯çŸ¥è¯†ç§¯ç´¯
- é€‚åˆå¤šæ­¥éª¤ä»»åŠ¡å’Œé•¿æœŸç ”ç©¶é¡¹ç›®

---

## å››ã€LangGraph å®æˆ˜ï¼šå®Œæ•´å®ç°

LangGraph æ˜¯ä¸€ä¸ªä½çº§ç¼–æ’æ¡†æ¶ï¼Œéå¸¸é€‚åˆå®ç°ä¸Šè¿°æŠ€å·§ã€‚æ ¸å¿ƒæ¦‚å¿µï¼š

- **Nodesï¼ˆèŠ‚ç‚¹ï¼‰**ï¼šå¤„ç†æ­¥éª¤ï¼Œæ¥æ”¶çŠ¶æ€å¹¶è¿”å›æ›´æ–°
- **Edgesï¼ˆè¾¹ï¼‰**ï¼šè¿æ¥èŠ‚ç‚¹ï¼Œåˆ›å»ºæ‰§è¡Œæµï¼ˆçº¿æ€§ã€æ¡ä»¶æˆ–å¾ªç¯ï¼‰
- **Stateï¼ˆçŠ¶æ€ï¼‰**ï¼šèŠ‚ç‚¹é—´å…±äº«çš„"è‰ç¨¿æœ¬"

å®˜æ–¹ä»“åº“æä¾›äº†6ä¸ª Jupyter Notebookï¼Œæ¯ä¸ªå¯¹åº”ä¸€ç§æŠ€å·§ï¼š

### Notebook 1: RAG
- ä½¿ç”¨ Lilian Weng çš„åšå®¢æ„å»ºæ£€ç´¢å·¥å…·
- Claude Sonnet ä½œä¸ºä¸»æ¨¡å‹
- ç³»ç»Ÿæç¤ºå¼•å¯¼æ¨¡å‹å…ˆæ˜ç¡®ç ”ç©¶èŒƒå›´
- 25k tokensï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰

### Notebook 2: Tool Loadout
- Python math åº“çš„æ‰€æœ‰å‡½æ•°ä½œä¸ºå·¥å…·æ± 
- å‘é‡æ•°æ®åº“ç´¢å¼•å·¥å…·æè¿°
- åŠ¨æ€ç»‘å®šå‰5ä¸ªæœ€ç›¸å…³å·¥å…·
- é¿å…å·¥å…·æè¿°é‡å å¯¼è‡´çš„æ··æ·†

### Notebook 3: Context Quarantine
- Supervisor å¤šæ™ºèƒ½ä½“æ¶æ„
- æ•°å­¦ä¸“å®¶æ™ºèƒ½ä½“ï¼ˆåŠ æ³•/ä¹˜æ³•å·¥å…·ï¼‰
- ç ”ç©¶ä¸“å®¶æ™ºèƒ½ä½“ï¼ˆç½‘é¡µæœç´¢å·¥å…·ï¼‰
- åŸºäºä»»åŠ¡ç±»å‹çš„æ™ºèƒ½è·¯ç”±

### Notebook 4: Context Pruning
- æ‰©å±• RAG Agentï¼Œå¢åŠ ä¿®å‰ªæ­¥éª¤
- GPT-4o-mini ä½œä¸ºä¿®å‰ªæ¨¡å‹ï¼ˆé™ä½æˆæœ¬ï¼‰
- åŸºäºç”¨æˆ·åŸå§‹è¯·æ±‚ä¿®å‰ªæ–‡æ¡£
- ä» 25k tokens â†’ **11k tokens**

### Notebook 5: Context Summarization
- åœ¨ RAG Agent åŸºç¡€ä¸Šå¢åŠ æ‘˜è¦æ­¥éª¤
- GPT-4o-mini è¿›è¡Œæ‘˜è¦ï¼ˆæˆæœ¬ä¼˜åŒ–ï¼‰
- ç›®æ ‡ï¼šå‹ç¼© 50-70%ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
- é€‚åˆæ‰€æœ‰å†…å®¹éƒ½ç›¸å…³ä½†å†—é•¿çš„åœºæ™¯

### Notebook 6: Context Offloading
- ä¸¤ç§æ¨¡å¼ï¼šä¼šè¯è‰ç¨¿æœ¬ + æŒä¹…åŒ–å†…å­˜
- `InMemoryStore` å®ç°è·¨ä¼šè¯å­˜å‚¨
- å‘½åç©ºé—´ç®¡ç†ä¸åŒç±»å‹çš„è®°å¿†
- æ”¯æŒç ”ç©¶å‹å·¥ä½œæµçš„çŸ¥è¯†ç§¯ç´¯

**ä»“åº“åœ°å€**ï¼š[langchain-ai/how_to_fix_your_context](https://github.com/langchain-ai/how_to_fix_your_context)

**Staræ•°**ï¼š452ï¼ˆæˆªè‡³å‘æ–‡ï¼‰

---

## äº”ã€å…³é”®æ´å¯Ÿä¸å®è·µå»ºè®®

### æ ¸å¿ƒè®¤çŸ¥ï¼šä¸Šä¸‹æ–‡ä¸æ˜¯å…è´¹çš„

è¿™æ˜¯æ‰€æœ‰æŠ€å·§çš„åº•å±‚é€»è¾‘ï¼š

> **ä¸Šä¸‹æ–‡ä¸­çš„æ¯ä¸ª token éƒ½ä¼šå½±å“æ¨¡å‹è¡Œä¸ºï¼Œä¸ç®¡å¥½åã€‚**

ç™¾ä¸‡çº§ä¸Šä¸‹æ–‡çª—å£ç¡®å®å¼ºå¤§ï¼Œä½†ç»ä¸æ˜¯"ä¿¡æ¯ç®¡ç†é©¬è™"çš„å€Ÿå£ã€‚

### ç¼–ç¨‹ LLM = ä¸Šä¸‹æ–‡ç®¡ç†

Karpathy çš„é‡‘å¥ï¼š
> "ä¸Šä¸‹æ–‡å·¥ç¨‹æ˜¯ç¼–ç¨‹ LLMï¼Œè®©å®ƒ'æ°åˆ°å¥½å¤„åœ°æ‰“åŒ…ä¸Šä¸‹æ–‡çª—å£'ã€‚"

å·§å¦™éƒ¨ç½²å·¥å…·ã€ä¿¡æ¯å’Œå®šæœŸç»´æŠ¤ï¼Œæ‰æ˜¯ Agent è®¾è®¡å¸ˆçš„æ ¸å¿ƒå·¥ä½œã€‚

### é€‰æ‹©åˆé€‚çš„æŠ€å·§ç»„åˆ

| é—®é¢˜ | æ¨èæŠ€å·§ |
|------|---------|
| æ–‡æ¡£å¤ªå¤š | RAG + ä¿®å‰ª/æ‘˜è¦ |
| å·¥å…·è¿‡è½½ | å·¥å…·è£…è½½ |
| ä»»åŠ¡å¯å¹¶è¡Œ | ä¸Šä¸‹æ–‡éš”ç¦» |
| é•¿æœŸå¯¹è¯ | æ‘˜è¦ + å¸è½½ |
| å¤šæ¥æºå†²çª | éš”ç¦» + ä¿®å‰ª |
| å†å²è®°å½•è†¨èƒ€ | å¸è½½ |

### è¯„ä¼°æ£€æŸ¥æ¸…å•

åœ¨æ„å»ºæˆ–ä¼˜åŒ– Agent æ—¶ï¼Œé—®è‡ªå·±ï¼š

1. âœ… ä¸Šä¸‹æ–‡ä¸­çš„æ¯æ¡ä¿¡æ¯éƒ½"ç‰©æœ‰æ‰€å€¼"å—ï¼Ÿ
2. âœ… æœ‰æ²¡æœ‰æ— å…³çš„å·¥å…·å®šä¹‰ï¼Ÿ
3. âœ… å†å²è®°å½•æ˜¯å¦è¿‡é•¿ï¼Ÿ
4. âœ… æ˜¯å¦æœ‰å†…éƒ¨çŸ›ç›¾çš„ä¿¡æ¯ï¼Ÿ
5. âœ… èƒ½å¦æ‹†åˆ†æˆç‹¬ç«‹å­ä»»åŠ¡ï¼Ÿ
6. âœ… æ˜¯å¦éœ€è¦è·¨ä¼šè¯è®°å¿†ï¼Ÿ

---

## å…­ã€æ€»ç»“

ç™¾ä¸‡çº§ä¸Šä¸‹æ–‡çª—å£å¸¦æ¥äº†æ— é™å¯èƒ½ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ–°çš„å¤±æ•ˆæ¨¡å¼ã€‚ä½œä¸ºå¤§æ¨¡å‹å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬éœ€è¦ï¼š

**ç†è§£4ç§å¤±æ•ˆæ¨¡å¼**ï¼š
- ğŸ§ª ä¸Šä¸‹æ–‡ä¸­æ¯’ï¼šå¹»è§‰è¢«åå¤å¼•ç”¨
- ğŸ¯ ä¸Šä¸‹æ–‡å¹²æ‰°ï¼šè¿‡åº¦ä¾èµ–å†å²
- ğŸŒ€ ä¸Šä¸‹æ–‡æ··æ·†ï¼šæ— å…³ä¿¡æ¯å¹²æ‰°
- âš”ï¸ ä¸Šä¸‹æ–‡å†²çªï¼šä¿¡æ¯è‡ªç›¸çŸ›ç›¾

**æŒæ¡6å¤§ä¿®å¤æŠ€å·§**ï¼š
1. ğŸ“š **RAG**ï¼šç²¾å‡†æ£€ç´¢ç›¸å…³ä¿¡æ¯
2. ğŸ® **å·¥å…·è£…è½½**ï¼šåŠ¨æ€é€‰æ‹©å¿…è¦å·¥å…·
3. ğŸ”’ **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šç‹¬ç«‹çº¿ç¨‹å¹¶è¡Œå¤„ç†
4. âœ‚ï¸ **ä¸Šä¸‹æ–‡ä¿®å‰ª**ï¼šåˆ é™¤æ— å…³å†…å®¹
5. ğŸ“ **ä¸Šä¸‹æ–‡æ‘˜è¦**ï¼šå‹ç¼©å†—é•¿ä¿¡æ¯
6. ğŸ’¾ **ä¸Šä¸‹æ–‡å¸è½½**ï¼šå¤–éƒ¨å­˜å‚¨ç®¡ç†

**å»ºç«‹æ ¸å¿ƒç†å¿µ**ï¼š
> ä¸Šä¸‹æ–‡ä¸æ˜¯å…è´¹çš„ã€‚ä¸Šä¸‹æ–‡ç®¡ç†æ˜¯ Agent è®¾è®¡çš„æ ¸å¿ƒå·¥ä½œã€‚

ç°åœ¨ï¼Œå»æ£€æŸ¥ä½ çš„ Agent å§â€”â€”ä¸Šä¸‹æ–‡ä¸­çš„æ¯ä¸ª token éƒ½"é…å¾—ä¸Š"å®ƒçš„ä½ç½®å—ï¼Ÿ

å¦‚æœæ²¡æœ‰ï¼Œä½ å·²ç»çŸ¥é“è¯¥æ€ä¹ˆåšäº†ã€‚ğŸ¯

---

## å‚è€ƒèµ„æ–™

1. Drew Breunig - [How to Fix Your Context](https://www.dbreunig.com/2025/06/26/how-to-fix-your-context.html)
2. Drew Breunig - [How Contexts Fail and How to Fix Them](https://www.dbreunig.com/2025/06/22/how-contexts-fail-and-how-to-fix-them.html)
3. LangChain - [how_to_fix_your_context GitHub](https://github.com/langchain-ai/how_to_fix_your_context)
4. Chroma - [Context Rot Report](https://research.trychroma.com/context-rot)
5. Google DeepMind - [Gemini 2.5 Technical Report](https://storage.googleapis.com/deepmind-media/gemini/gemini_v2_5_report.pdf)
6. Berkeley - [Function-Calling Leaderboard](https://gorilla.cs.berkeley.edu/leaderboard.html)
7. Anthropic - [Multi-Agent Research System](https://www.anthropic.com/engineering/built-multi-agent-research-system)
8. Anthropic - [Claude Think Tool](https://www.anthropic.com/engineering/claude-think-tool)

---

**å…³äºä½œè€…**

æˆ‘æ˜¯é˜¿ä¸œï¼Œå¤§æ¨¡å‹ç®—æ³•å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºå¤§æ¨¡å‹åº”ç”¨è½åœ°å’ŒçŸ¥è¯†åˆ†äº«ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµã€åœ¨çœ‹ã€è½¬å‘ï¼Œè®©æ›´å¤šäººçœ‹åˆ°ï¼

æœ‰ä»»ä½•é—®é¢˜æˆ–æƒ³æ·±å…¥äº¤æµçš„è¯é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ï½


